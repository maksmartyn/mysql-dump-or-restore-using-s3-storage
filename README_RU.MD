# MySQL dump/restore Docker-image

[üá∫üá∏ English docs](README.MD)

------

## –ß—Ç–æ —ç—Ç–æ?

–û–±—Ä–∞–∑ –¥–ª—è –±—ç–∫–∞–ø–∞ –∏–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –¥–∞–º–ø–∞ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö MySQL —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º S3-—Ö—Ä–∞–Ω–∏–ª–∏—â–∞

## –î–ª—è —á–µ–≥–æ?

–î–ª—è –æ–±–ª–µ–≥—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –±—ç–∫–∞–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ MySQL –∏–ª–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –±—ç–∫–∞–ø–æ–≤ –Ω–∞ —Å–º–µ–∂–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö

## –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è?

### –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

#### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MySQL:

```dotenv
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=root
DB_PASSWORD=
```

–ï—Å–ª–∏ –≤–∞—à MySQL –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ, —Ç–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `DB_HOST` –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∏–º—è —Å–µ—Ä–≤–∏—Å–∞ MySQL –≤ docker

> **–í–ê–ñ–ù–û:** –µ—Å–ª–∏ –≤–∞—à MySQL –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∏ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω —Å–Ω–∞—Ä—É–∂–∏ —Å–µ—Ç–∏ docker'–∞, —Ç–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —ç—Ç–æ—Ç –æ–±—Ä–∞–∑ –Ω—É–∂–Ω–æ –≤ —Ç–æ–π –∂–µ —Å–µ—Ç–∏, –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å MySQL

#### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ S3 —Ö—Ä–∞–Ω–∏–ª–∏—â—É

```dotenv
S3_ACCESS_KEY=12345qwerty
S3_SECRET_KEY=12345qwerty
S3_REGION=ru-1
S3_HOST=s3.ru-1.storage.selcdn.ru
S3_HOST_BUCKET=s3.ru-1.storage.selcdn.ru
S3_CONTAINER_NAME=myfiles
```

> –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –≤–∞—à–µ–≥–æ S3 —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è `S3_HOST_BUCKET` –º–æ–∂–µ—Ç —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ-—Ä–∞–∑–Ω–æ–º—É.
> –ù–∞–ø—Ä–∏–º–µ—Ä –≤ Selectel –∫–æ–≥–¥–∞-—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –¥–æ–º–µ–Ω—ã —Ñ–æ—Ä–º–∞—Ç–∞ {bucket_id}.selcdn.ru/{container_name} 
–≥–¥–µ –≤ –∫–∞—á–µ—Å—Ç–≤–µ `bucket_id` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Ü–∏—Ñ—Ä–æ–≤–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ö—Ä–∞–Ω–∏–ª–∏—â–∞, 
–∞ `container_name` —É–∂–µ –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ —ç—Ç–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. 
–û–¥–Ω–∞–∫–æ –ø–æ–∑–¥–Ω–µ–µ –±—ã–ª–æ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω s3.ru-1.storage.selcdn.ru

#### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∫–æ–º–∞–Ω–¥—ã `backup` –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –¥–∞–º–ø –≤—Å–µ—Ö –ë–î –∏ —Ç–∞–±–ª–∏—Ü. 
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç—å –∫–∞–∫–∏–µ-–ª–∏–±–æ –ë–î –∏/–∏–ª–∏ —Ç–∞–±–ª–∏—Ü—ã, —Ç–æ –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
```dotenv
# The names of excluded tables are separated by commas(,)
DB_IGNORE_TABLES=table1,table2

# default (^mysql|_schema$|^sys$)
DB_IGNORE_DATABASE_REGEX=(^mysql|_schema$|^sys$|^test_)
```

–¢–∞–∫–∂–µ –µ—Å–ª–∏ –í—ã –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—Ç—á–∞—è–Ω—ã–π –∏ –Ω–µ –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ ssl –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
–∏–ª–∏ –∂–µ –≤–∞—à–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º –∫–æ–Ω—Ç—É—Ä–µ —Å–µ—Ç–∏, 
—Ç–æ –º–æ–∂–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å ssl (–ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–ª–∏ —Ç–æ–ª—å–∫–æ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏)
```dotenv
S3_SSL=true
S3_SSL_CHECK_CERT=true
S3_SSL_CHECK_HOST=false
```

### –ó–∞–ø—É—Å–∫

#### –ë–µ–∑ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ä–µ–µ—Å—Ç—Ä–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

```shell
docker build -t my-dumper . && docker run --rm --env-file /path/to/env-file --network my_project_network my-dumper backup my_db_name
```
–∏–ª–∏ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Docker Compose:
```yaml
# my-compose.yml
networks:
  default:
    name: my_project_network

services:
  my-dumper-service:
    build: .
    env_file: .env
    command: "backup my_db_name"
```
```shell
docker compose -f my-compose.yml build my-dumper-service && docker compose -f my-compose.yml run --rm my-dumper-service
```

#### –° —Ä–µ–µ—Å—Ç—Ä–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

–†–∞–∑—É–º–µ–µ—Ç—Å—è –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–±–æ—Ä–∫—É –∏ –ø—É—à –æ–±—Ä–∞–∑–∞ –≤ —Ä–µ–µ—Å—Ç—Ä.

```shell
docker pull registry.your-domain/path/to/image && docker run --rm --env-file /path/to/env-file --network my_project_network registry.your-domain/path/to/image backup my_db_name
```
–∏–ª–∏ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Docker Compose:
```yaml
# my-compose.yml
networks:
  default:
    name: my_project_network

services:
  my-dumper-service:
    image: registry.your-domain/path/to/image
    env_file: .env
    command: "backup my_db_name"
```
```shell
docker compose -f my-compose.yml pull my-dumper-service && docker compose -f my-compose.yml run --rm my-dumper-service
```

### –ö–æ–º–∞–Ω–¥—ã

**–ë—ç–∫–∞–ø:**
```
backup [DB_NAME]
```
–ö–æ–º–∞–Ω–¥–µ `backup` –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –∏–º—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ë–î, –∏–Ω–∞—á–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –¥–∞–º–ø –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ë–î.

**–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:**
```
restore DB_NAME [DATE] [TARGET_DB_NAME]
```
–ö–æ–º–∞–Ω–¥–∞ `restore` —Ç—Ä–µ–±—É–µ—Ç –∏–º—è –ë–î –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∞—Ä–≥—É–º–µ–Ω—Ç–∞. 

–¢–∞–∫ –∂–µ –µ—Å–ª–∏ –í–∞–º –Ω—É–∂–µ–Ω –¥–∞–º–ø –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É, 
—Ç–æ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –µ–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î, 
–∏–Ω–∞—á–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞.

–ï—â–µ –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∏–º—è —Ü–µ–ª–µ–≤–æ–π –ë–î - –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –¥–∞–º–ø–∞ –±–∞–∑—ã `DB_NAME` –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞, –Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω –æ–Ω –±—É–¥–µ—Ç –∫ –±–∞–∑–µ `TARGET_DB_NAME`